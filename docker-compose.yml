#========================================================
# docker-compose.yml for ERPNext–WooCommerce Integration
#========================================================
version: '3.8'

services:
  integration:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: erp-woo-int
    working_dir: /code
    volumes:
      - ./:/code

    env_file:
      - ./.env

    command: [ "uvicorn", "app.main_app:app", "--host", "0.0.0.0", "--port", "8000", "--log-level", "debug" ]
    ports:
      - "8000:8000"

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=frappe_default"
      # internal port for Traefik
      - "traefik.http.services.integration.loadbalancer.server.port=8000"

    networks:
      - frappe_default
    restart: unless-stopped

  admin-ui:
    build:
      context: ./admin-ui
      target: dev
    container_name: admin-ui
    ports:
      - "3000:3000"

    # Load all secrets/config from the single root .env
    env_file:
      - ./.env
    environment:
      - NEXT_TELEMETRY_DISABLED=1
      - INTEGRATION_BASE_URL=http://integration:8000
      - INTEGRATION_ADMIN_USER=${ADMIN_USER}
      - INTEGRATION_ADMIN_PASS=${ADMIN_PASS}

    depends_on:
      - integration

    volumes:
      - ./admin-ui:/app
      - /app/node_modules
      - /app/.next

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=frappe_default"
      # ✅ Route everything under /admin (incl. /admin/api) to Next.js (server routes proxy to FastAPI)
      - "traefik.http.routers.admin-ui.rule=Host(`records.techniclad.co.za`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.admin-ui.entrypoints=websecure"
      - "traefik.http.routers.admin-ui.tls.certresolver=main-resolver"
      - "traefik.http.services.admin-ui.loadbalancer.server.port=3000"

    networks:
      - frappe_default

networks:
  frappe_default:
    external: true
